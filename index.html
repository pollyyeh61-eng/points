<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HOLY HAIR | å¥¢è¯æ™ºèƒ½ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root { --gold-gradient: linear-gradient(135deg, #BF953F 0%, #FCF6BA 45%, #B38728 70%, #FBF5B7 85%, #AA771C 100%); --dark-bg: #050505; }
        body { background-color: var(--dark-bg); color: #D4D4D4; font-family: 'Noto Sans TC', sans-serif; background-image: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #050505 100%); min-height: 100vh; padding-bottom: 90px; }
        .gold-text { background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: 'Cinzel', serif; letter-spacing: 0.15em; font-weight: 700; }
        .luxury-card { background: rgba(20, 20, 20, 0.7); border: 1px solid rgba(191, 149, 63, 0.15); backdrop-filter: blur(25px); border-radius: 28px; }
        input, textarea { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(191, 149, 63, 0.2); color: white; padding: 12px; border-radius: 12px; outline: none; }
        input:focus { border-color: #FCF6BA; box-shadow: 0 0 15px rgba(191, 149, 63, 0.4); }
        @keyframes gold-breathe { 0%, 100% { box-shadow: 0 0 5px rgba(191, 149, 63, 0.3); border-color: #BF953F; } 50% { box-shadow: 0 0 25px rgba(252, 246, 186, 0.7); border-color: #FCF6BA; } }
        .has-content { animation: gold-breathe 1.5s infinite !important; color: #FCF6BA !important; }
        .btn-luxury { background: rgba(10, 10, 10, 0.8); border: 1px solid #8A6E2F; border-radius: 14px; cursor: pointer; transition: transform 0.1s; }
        .btn-luxury:active { transform: scale(0.95); }
        /* é›†é»å¡æ¨£å¼ */
        .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .stamp-slot { width: 100%; aspect-ratio: 1; border-radius: 50%; border: 1px solid rgba(191, 149, 63, 0.2); display: flex; align-items: center; justify-content: center; font-size: 12px; background: rgba(255,255,255,0.02); transition: 0.5s; }
        .stamp-active { background: var(--gold-gradient); color: #000; border: none; box-shadow: 0 0 15px rgba(191, 149, 63, 0.5); transform: scale(1.05); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .active .accordion-content { max-height: 500px; padding: 15px 0; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: rgba(5,5,5,0.9); backdrop-filter: blur(15px); border-top: 1px solid rgba(191, 149, 63, 0.2); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { font-size: 11px; color: #555; }
        .nav-item.active { color: #BF953F; }
    </style>
</head>
<body class="px-5">

    <div id="page-member" class="page-content py-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl gold-text mb-1">ç¾æ¥­ç®¡ç†ç³»çµ±</h1>
            <p class="text-[9px] tracking-[0.5em] text-gray-600 uppercase">Premium Intelligence</p>
        </header>

        <section class="luxury-card p-6 mb-6">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="reg-name" placeholder="å§“å" oninput="autoSave()">
                    <input type="tel" id="reg-phone" placeholder="é›»è©±" oninput="autoSave()">
                </div>
                <textarea id="reg-note" placeholder="å‚™è¨»..." rows="1" class="w-full" oninput="checkNote()"></textarea>
                <button id="save-btn" onclick="registerNewMember()" class="w-full btn-luxury py-3 text-xs gold-text">
                    å»ºç«‹æ–°æœƒå“¡å¡
                </button>
            </div>
        </section>

        <section class="luxury-card p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <span id="display-card-id" class="text-[10px] text-gray-500 font-mono">ID: ---</span>
                    <h2 id="display-name" class="text-2xl font-bold text-white mt-1">æœªé¸å–æœƒå“¡</h2>
                </div>
                <div class="text-right">
                    <span class="text-[10px] text-gray-500 uppercase">ç´¯è¨ˆæ¶ˆè²»</span>
                    <p id="total-spent" class="text-xl text-white font-light">$0</p>
                </div>
            </div>
            
            <div class="mb-6">
                <div class="flex justify-between text-[10px] mb-1">
                    <span id="tier-display" class="gold-text">LV.0 å…¥é–€æœƒå“¡</span>
                    <span id="incentive-text" class="text-gray-500"></span>
                </div>
                <div class="w-full h-1 bg-black rounded-full overflow-hidden border border-white/5">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-[#BF953F] to-[#FCF6BA] transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>

            <div class="stamp-grid" id="stamp-container">
                </div>
        </section>

        <section class="luxury-card p-5 space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <input type="number" id="tech-income" placeholder="æŠ€è¡“ $1000" class="text-center">
                <input type="number" id="prod-income" placeholder="ç”¢å“ $0" class="text-center">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="handleCheckOut()" class="btn-luxury py-3 text-xs gold-text font-bold">çµå¸³ä¸¦é›†é»</button>
                <button onclick="handleRedeem()" class="btn-luxury py-3 text-xs text-red-400 border-red-900/30">æ ¸éŠ·é»æ•¸</button>
            </div>
        </section>
    </div>

    <div id="page-list" class="page-content py-6 hidden">
        <header class="text-center mb-6">
            <h1 class="text-2xl gold-text mb-1">æœƒå“¡æ¸…å–®</h1>
            <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å§“åæˆ–é›»è©±..." class="mt-4 w-full text-xs" oninput="renderDirectory()">
        </header>
        <div id="member-directory" class="space-y-4 pb-10"></div>
    </div>

    <nav class="bottom-nav">
        <button onclick="switchPage('member')" id="nav-member" class="nav-item active flex flex-col items-center"><span>â¬¡</span><span>æ§åˆ¶é¢æ¿</span></button>
        <button onclick="switchPage('list')" id="nav-list" class="nav-item flex flex-col items-center"><span>â˜·</span><span>åå–®å€‰åº«</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
            databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
            projectId: "holyhairsalon-f73bf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let activeUserId = localStorage.getItem('lastActiveId') || "";

        const RULES = [
            { level: 0, name: "å…¥é–€æœƒå“¡", threshold: 1000 },
            { level: 1, name: "åŸºç¤æœƒå“¡", threshold: 3000 },
            { level: 2, name: "ç†Ÿå®¢æœƒå“¡", threshold: 5000 },
            { level: 3, name: "å„ªé¸æœƒå“¡", threshold: 7000 },
            { level: 4, name: "èè‹±æœƒå“¡", threshold: 10000 },
            { level: 5, name: "å°Šæ¦®æœƒå“¡", threshold: 999999 }
        ];

        // --- æ ¸å¿ƒé‚è¼¯ï¼šå»ºç«‹æœƒå“¡ ---
        window.registerNewMember = async () => {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            if(!name || !phone) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

            const snap = await get(ref(db, 'members'));
            const nextId = String((snap.exists() ? Object.keys(snap.val()).length : 0) + 1).padStart(3, '0');

            await set(ref(db, 'members/' + nextId), {
                id: nextId, name, phone, note: document.getElementById('reg-note').value,
                total_spent: 0, stamps: 0
            });

            activeUserId = nextId;
            localStorage.setItem('lastActiveId', nextId);
            alert("æœƒå“¡å·²åŠ å…¥å€‰åº«ï¼");
            bindActiveMember();
        };

        // --- æ ¸å¿ƒé‚è¼¯ï¼šçµå¸³èˆ‡é›†é» ---
        window.handleCheckOut = async () => {
            if(!activeUserId) return alert("è«‹å…ˆé¸å–æœƒå“¡");
            const tech = parseInt(document.getElementById('tech-income').value) || 0;
            const prod = parseInt(document.getElementById('prod-income').value) || 0;
            const total = tech + prod;

            const userRef = ref(db, 'members/' + activeUserId);
            const snap = await get(userRef);
            if(snap.exists()){
                const d = snap.val();
                const newStamps = Math.min((d.stamps || 0) + 1, 10);
                
                await update(userRef, { 
                    total_spent: (d.total_spent || 0) + total,
                    stamps: newStamps
                });

                await set(push(ref(db, 'pos_sales_log')), {
                    timestamp: Date.now(), member_id: activeUserId, tech_income: tech, prod_income: prod
                });

                alert(`çµå¸³å®Œæˆï¼ç´¯ç©é»æ•¸ï¼š${newStamps}`);
            }
        };

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæ ¸éŠ·é»æ•¸ ---
        window.handleRedeem = async () => {
            if(!activeUserId) return alert("è«‹å…ˆé¸å–æœƒå“¡");
            const userRef = ref(db, 'members/' + activeUserId);
            const snap = await get(userRef);
            if(snap.exists() && snap.val().stamps >= 10){
                if(confirm("ç¢ºå®šæ ¸éŠ· 10 é»å…Œæ›çå‹µï¼Ÿ")){
                    await update(userRef, { stamps: 0 });
                    alert("æ ¸éŠ·æˆåŠŸï¼é»æ•¸å·²æ­¸é›¶ã€‚");
                }
            } else {
                alert("é»æ•¸ä¸è¶³ 10 é»ï¼Œç„¡æ³•æ ¸éŠ·ã€‚");
            }
        };

        function bindActiveMember() {
            if(!activeUserId) return;
            onValue(ref(db, 'members/' + activeUserId), (snap) => {
                if(snap.exists()) updateUI(snap.val());
            });
        }

        function updateUI(data) {
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('display-card-id').innerText = `ID: ${data.id}`;
            document.getElementById('total-spent').innerText = `$${(data.total_spent || 0).toLocaleString()}`;
            
            // æ›´æ–°é€²åº¦èˆ‡ç­‰ç´š
            let current = RULES.findLast(r => (data.total_spent || 0) >= (RULES[r.level-1]?.threshold || 0)) || RULES[0];
            document.getElementById('tier-display').innerText = `LV.${current.level} ${current.name}`;
            const next = RULES[current.level + 1];
            if(next){
                const p = ((data.total_spent || 0) / next.threshold) * 100;
                document.getElementById('progress-bar').style.width = `${Math.min(p, 100)}%`;
                document.getElementById('incentive-text').innerText = `å·® $${next.threshold - data.total_spent} å‡ç­‰`;
            }

            // æ›´æ–°é›†é»æ ¼
            const container = document.getElementById('stamp-container');
            container.innerHTML = "";
            for(let i=1; i<=10; i++){
                const slot = document.createElement('div');
                slot.className = `stamp-slot ${i <= (data.stamps || 0) ? 'stamp-active' : ''}`;
                slot.innerText = i <= (data.stamps || 0) ? 'âœ¦' : i;
                container.appendChild(slot);
            }
        }

        // --- åå–®å€‰åº«æ¸²æŸ“ ---
        window.renderDirectory = async () => {
            const search = document.getElementById('search-input').value.toLowerCase();
            const snap = await get(ref(db, 'members'));
            const container = document.getElementById('member-directory');
            container.innerHTML = "";
            if(snap.exists()){
                Object.values(snap.val()).forEach(m => {
                    if(!m.name.toLowerCase().includes(search) && !m.phone.includes(search)) return;
                    const item = document.createElement('div');
                    item.className = "luxury-card p-4 mb-3";
                    item.innerHTML = `
                        <div class="flex justify-between items-center" onclick="this.classList.toggle('active')">
                            <span class="gold-text">ID:${m.id} ${m.name}</span>
                            <button onclick="activeUserId='${m.id}'; switchPage('member')" class="text-[10px] border border-[#BF953F]/40 px-3 py-1 rounded">é¸å–</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
        };

        window.switchPage = (pid) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${pid}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pid}`).classList.add('active');
            if(pid === 'list') renderDirectory();
        };

        window.onload = () => { bindActiveMember(); };
    </script>
</body>
</html>
