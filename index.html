<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HOLY HAIR | å¥¢è¯æ™ºèƒ½ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-gradient: linear-gradient(135deg, #BF953F 0%, #FCF6BA 45%, #B38728 70%, #FBF5B7 85%, #AA771C 100%);
            --dark-bg: #050505;
        }

        body {
            background-color: var(--dark-bg);
            color: #D4D4D4;
            font-family: 'Noto Sans TC', sans-serif;
            background-image: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #050505 100%);
            min-height: 100vh;
            padding-bottom: 90px;
        }

        /* å¥¢è¯æ¨™é¡Œï¼šé‡‘å±¬æ¼†è³ªæ„Ÿ */
        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.15em;
            font-weight: 700;
        }

        /* ç£¨ç ‚ç»ç’ƒå¡ç‰‡ */
        .luxury-card {
            background: rgba(20, 20, 20, 0.7);
            border: 1px solid rgba(191, 149, 63, 0.15);
            backdrop-filter: blur(25px);
            border-radius: 28px;
            transition: all 0.3s ease;
        }

        /* è¼¸å…¥æ¡†é‡‘è‰²å…‰æšˆ */
        input, textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(191, 149, 63, 0.2);
            color: white;
            padding: 12px;
            border-radius: 12px;
            outline: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input:focus, textarea:focus {
            border-color: #FCF6BA;
            box-shadow: 0 0 15px rgba(191, 149, 63, 0.4);
            background: rgba(255, 255, 255, 0.08);
        }

        /* æ™ºèƒ½æ„Ÿæ‡‰ï¼šé‡‘å…‰å‘¼å¸æ•ˆæœ */
        @keyframes gold-breathe {
            0%, 100% { box-shadow: 0 0 5px rgba(191, 149, 63, 0.3); border-color: #BF953F; }
            50% { box-shadow: 0 0 25px rgba(252, 246, 186, 0.7); border-color: #FCF6BA; }
        }
        .has-content {
            animation: gold-breathe 1.5s infinite !important;
            color: #FCF6BA !important;
        }

        /* æŒ‰éˆ•é»æ“Šç¸®æ”¾ */
        .btn-luxury {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid #8A6E2F;
            border-radius: 14px;
            transition: transform 0.1s active;
            cursor: pointer;
        }
        .btn-luxury:active {
            transform: scale(0.95);
        }

        .stamp-slot { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(191, 149, 63, 0.15); display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .stamp-active { background: var(--gold-gradient); color: #000; box-shadow: 0 0 10px rgba(191, 149, 63, 0.4); border: none; }

        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .active .accordion-content { max-height: 500px; padding: 20px 0; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: rgba(5,5,5,0.9); backdrop-filter: blur(15px); border-top: 1px solid rgba(191, 149, 63, 0.2); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { font-size: 11px; color: #555; transition: 0.3s; }
        .nav-item.active { color: #BF953F; text-shadow: 0 0 10px rgba(191, 149, 63, 0.5); }
    </style>
</head>
<body class="px-5">

    <div id="page-member" class="page-content py-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl gold-text mb-1">ç¾æ¥­ç®¡ç†ç³»çµ±</h1>
            <p class="text-[9px] tracking-[0.5em] text-gray-600 uppercase">Premium Intelligence</p>
        </header>

        <section class="luxury-card p-6 mb-6">
            <h3 class="text-[10px] gold-text mb-4 tracking-widest uppercase">æœƒå“¡å»ºæª” / å‚™è¨»ç®¡ç†</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="reg-name" placeholder="é¡§å®¢å§“å" oninput="autoSave()">
                    <input type="tel" id="reg-phone" placeholder="é›»è©±è™Ÿç¢¼" oninput="autoSave()">
                </div>
                <textarea id="reg-note" placeholder="é¡§å®¢å‚™è¨»ï¼ˆè¼¸å…¥å¾Œå„²å­˜æŒ‰éˆ•æœƒç™¼å…‰...ï¼‰" rows="2" class="w-full" oninput="checkNote()"></textarea>
                <button id="save-btn" onclick="registerNewMember()" class="w-full btn-luxury py-3 text-xs font-bold uppercase tracking-widest text-[#8A6E2F]">
                    æ°¸ä¹…å„²å­˜è‡³ç³»çµ±
                </button>
            </div>
        </section>

        <main class="space-y-6">
            <section class="luxury-card p-6" id="main-card">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <span id="display-card-id" class="text-[10px] text-gray-500 font-mono tracking-widest">ID: 000</span>
                        <h2 id="display-name" class="text-2xl font-bold text-white mt-1">å°šæœªé¸å–æœƒå“¡</h2>
                        <p id="display-phone" class="text-xs text-gray-500 font-mono mt-1">è«‹å¾åå–®é¸å–æˆ–æ–°å»ºæª”</p>
                    </div>
                    <div class="w-12 h-12 rounded-full border border-[#BF953F]/30 flex items-center justify-center gold-text text-xl">âœ¦</div>
                </div>

                <div class="flex justify-between items-end mb-4">
                    <div>
                        <span class="text-[10px] text-gray-500 uppercase">å°Šæ¦®ç­‰ç´š</span>
                        <h3 id="tier-display" class="text-lg gold-text">LV.0 å…¥é–€æœƒå“¡</h3>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] text-gray-500 uppercase">å¹´åº¦æ¶ˆè²»</span>
                        <p id="total-spent" class="text-2xl text-white font-light">$0</p>
                    </div>
                </div>

                <div class="w-full h-1.5 bg-black rounded-full mb-3 overflow-hidden border border-white/5">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-[#BF953F] to-[#FCF6BA] transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p id="incentive-text" class="text-[11px] text-gray-500 italic text-center"></p>
            </section>

            <button onclick="handleCheckOut(1500)" class="w-full btn-luxury py-4 text-sm font-bold gold-text border-[#BF953F]">
                ç«‹å³å®Œæˆçµå¸³ ($1,500)
            </button>
        </main>
    </div>

    <div id="page-list" class="page-content py-6 hidden">
        <header class="text-center mb-6">
            <h1 class="text-2xl gold-text mb-1">åå–®ç¸½è¦½</h1>
            <input type="text" id="search-input" placeholder="ğŸ” è¼¸å…¥å§“åæˆ–é›»è©±æœå°‹..." class="mt-4 w-full text-xs" oninput="renderDirectory()">
        </header>
        <div id="member-directory" class="space-y-4">
            </div>
    </div>

    <nav class="bottom-nav">
        <button onclick="switchPage('member')" id="nav-member" class="nav-item active flex flex-col items-center">
            <span class="text-xl mb-1">â¬¡</span><span>æ§åˆ¶é¢æ¿</span>
        </button>
        <button onclick="switchPage('list')" id="nav-list" class="nav-item flex flex-col items-center">
            <span class="text-xl mb-1">â˜·</span><span>åå–®æ¸…å–®</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
            authDomain: "holyhairsalon-f73bf.firebaseapp.com",
            databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
            projectId: "holyhairsalon-f73bf",
            storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
            messagingSenderId: "960169055224",
            appId: "1:960169055224:web:64c044f4484f267abf3c0d",
            measurementId: "G-TLM1NMF4Y1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let activeUserId = localStorage.getItem('lastActiveId') || "001";

        const RULES = [
            { level: 0, name: "å…¥é–€æœƒå“¡", threshold: 1000 },
            { level: 1, name: "åŸºç¤æœƒå“¡", threshold: 3000 },
            { level: 2, name: "ç†Ÿå®¢æœƒå“¡", threshold: 5000 },
            { level: 3, name: "å„ªé¸æœƒå“¡", threshold: 7000 },
            { level: 4, name: "èè‹±æœƒå“¡", threshold: 10000 },
            { level: 5, name: "å°Šæ¦®æœƒå“¡", threshold: 999999 }
        ];

        // --- æ ¸å¿ƒé‚è¼¯ï¼šå³æ™‚æš«å­˜ (Auto-Save) ---
        window.autoSave = () => {
            const data = {
                name: document.getElementById('reg-name').value,
                phone: document.getElementById('reg-phone').value,
                note: document.getElementById('reg-note').value
            };
            localStorage.setItem('temp_member_data', JSON.stringify(data));
        };

        // --- æ ¸å¿ƒé‚è¼¯ï¼šå‚™è¨»æ„Ÿæ‡‰å‘¼å¸ç‡ˆ ---
        window.checkNote = () => {
            const note = document.getElementById('reg-note').value;
            const btn = document.getElementById('save-btn');
            if(note.length > 0) btn.classList.add('has-content');
            else btn.classList.remove('has-content');
            autoSave();
        };

        // --- æœƒå“¡è¨»å†Š (Firebase + LocalStorage) ---
        window.registerNewMember = async () => {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const note = document.getElementById('reg-note').value;
            if(!name || !phone) return alert("è«‹å¡«å¯«åŸºæœ¬è³‡æ–™");

            const colRef = collection(db, "customers");
            const snapshot = await getDocs(colRef);
            const nextId = String(snapshot.size + 1).padStart(3, '0');

            const newMember = {
                id: nextId, name, phone, note,
                total_spent: 0, stamps: 0, created_at: Date.now()
            };

            await setDoc(doc(db, "customers", nextId), newMember);
            activeUserId = nextId;
            localStorage.setItem('lastActiveId', nextId);
            
            // æ¸…é™¤æš«å­˜
            localStorage.removeItem('temp_member_data');
            document.getElementById('reg-note').value = "";
            checkNote();
            
            alert(`é‡‘å¡ç™¼è¡ŒæˆåŠŸï¼ID: ${nextId}`);
            bindActiveMember();
        };

        // --- ç¶å®šå³æ™‚ç›£è½ ---
        function bindActiveMember() {
            onSnapshot(doc(db, "customers", activeUserId), (snap) => {
                if(snap.exists()) updateUI(snap.data());
            });
        }

        function updateUI(data) {
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('display-phone').innerText = data.phone;
            document.getElementById('display-card-id').innerText = `ID: ${data.id}`;
            document.getElementById('total-spent').innerText = `$${data.total_spent.toLocaleString()}`;
            
            let current = RULES.findLast(r => data.total_spent >= (RULES[r.level-1]?.threshold || 0)) || RULES[0];
            document.getElementById('tier-display').innerText = `LV.${current.level} ${current.name}`;
            
            const next = RULES[current.level + 1];
            if(next) {
                const prog = (data.total_spent / next.threshold) * 100;
                document.getElementById('progress-bar').style.width = `${Math.min(prog, 100)}%`;
                document.getElementById('incentive-text').innerText = `è· ${next.name} é‚„å·® $${(next.threshold - data.total_spent).toLocaleString()}`;
            }
        }

        // --- çµå¸³åŠŸèƒ½ ---
        window.handleCheckOut = async (amount) => {
            const userRef = doc(db, "customers", activeUserId);
            const snap = await getDoc(userRef);
            if(!snap.exists()) return alert("è«‹å…ˆå»ºç«‹æˆ–é¸å–æœƒå“¡");

            const newTotal = snap.data().total_spent + amount;
            await updateDoc(userRef, { total_spent: newTotal, stamps: (snap.data().stamps + 1) % 11 });
            
            // å‡ç­‰ç‰¹æ•ˆ
            const nextRule = RULES.find(r => r.threshold > snap.data().total_spent && newTotal >= r.threshold);
            if(nextRule) alert(`ğŸŠ å°Šæ¦®æ™‰å‡ï¼šæ‚¨å·²æˆç‚º ${nextRule.name}ï¼`);
        };

        // --- åˆ†é èˆ‡å³æ™‚æœå°‹ ---
        window.switchPage = (pid) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${pid}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pid}`).classList.add('active');
            if(pid === 'list') renderDirectory();
        };

        async function renderDirectory() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const colRef = collection(db, "customers");
            const snapshot = await getDocs(colRef);
            const container = document.getElementById('member-directory');
            container.innerHTML = "";

            snapshot.forEach((docSnap) => {
                const m = docSnap.data();
                if(!m.name.toLowerCase().includes(searchTerm) && !m.phone.includes(searchTerm)) return;

                const tier = RULES.findLast(r => m.total_spent >= (RULES[r.level-1]?.threshold || 0)) || RULES[0];
                const item = document.createElement('div');
                item.className = "accordion-item luxury-card mb-4";
                item.innerHTML = `
                    <div class="p-5 flex justify-between items-center" onclick="this.parentElement.classList.toggle('active')">
                        <div>
                            <span class="text-[10px] gold-text font-bold px-2 py-1 bg-black/50 rounded-md border border-[#BF953F]/20">ID:${m.id}</span>
                            <span class="ml-3 text-white font-medium">${m.name}</span>
                        </div>
                        <span class="text-[10px] text-gray-600 tracking-tighter">${tier.name}</span>
                    </div>
                    <div class="accordion-content bg-black/20 px-5">
                        <div class="space-y-3 text-xs border-t border-white/5 pt-4">
                            <div class="flex justify-between text-gray-400"><span>é›»è©±</span><span class="text-gray-200">${m.phone}</span></div>
                            <div class="flex justify-between text-gray-400"><span>æ¶ˆè²»ç¸½é¡</span><span class="gold-text">$${m.total_spent}</span></div>
                            <div class="p-3 bg-white/5 rounded-lg text-gray-400 italic font-light">å‚™è¨»ï¼š${m.note || 'å°šç„¡å‚™è¨»'}</div>
                            <button onclick="activeUserId='${m.id}'; switchPage('member');" class="w-full btn-luxury py-3 text-[10px] gold-text mt-2">å•Ÿå‹•ç®¡ç†é¢æ¿</button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // é é¢è¼‰å…¥æ™‚æ¢å¾©æš«å­˜æ•¸æ“š
        window.onload = () => {
            const saved = localStorage.getItem('temp_member_data');
            if(saved) {
                const { name, phone, note } = JSON.parse(saved);
                document.getElementById('reg-name').value = name || "";
                document.getElementById('reg-phone').value = phone || "";
                document.getElementById('reg-note').value = note || "";
                checkNote();
            }
            bindActiveMember();
        };
    </script>
</body>
</html>
