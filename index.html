<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>美業管理系統 | HOLY HAIR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-gradient: linear-gradient(135deg, #BF953F 0%, #FCF6BA 45%, #B38728 70%, #FBF5B7 85%, #AA771C 100%);
            --dark-bg: #050505;
        }

        body {
            background-color: var(--dark-bg);
            color: #D4D4D4;
            font-family: 'Noto Sans TC', sans-serif;
            background-image: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #050505 100%);
            min-height: 100vh;
            padding-bottom: 80px; /* 為底欄留空間 */
        }

        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .luxury-card {
            background: rgba(15, 15, 15, 0.85);
            border: 1px solid rgba(191, 149, 63, 0.2);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            animation: card-breathe 5s ease-in-out infinite;
        }

        @keyframes card-breathe {
            0%, 100% { border-color: rgba(191, 149, 63, 0.2); box-shadow: 0 0 15px rgba(0,0,0,0.8); }
            50% { border-color: rgba(191, 149, 63, 0.5); box-shadow: 0 0 35px rgba(191, 149, 63, 0.15); }
        }

        /* 4秒週期流金按鈕 */
        .btn-luxury-cycle {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #8A6E2F;
            border-radius: 12px;
            animation: btn-glow-cycle 4s infinite;
            transition: all 0.3s;
        }

        @keyframes btn-glow-cycle {
            0%, 100% { color: #8A6E2F; border-color: #8A6E2F; }
            50% { color: #FCF6BA; border-color: #FCF6BA; box-shadow: 0 0 15px rgba(252, 246, 186, 0.2); }
        }

        .stamp-slot {
            width: 32px; height: 32px; border-radius: 50%;
            border: 1px solid rgba(191, 149, 63, 0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; background: rgba(255, 255, 255, 0.03);
        }

        .stamp-active {
            background: var(--gold-gradient); color: #000; border: none; box-shadow: 0 0 10px rgba(191, 149, 63, 0.5);
        }

        /* 風琴式抽屜動畫 */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-item.active .accordion-content {
            max-height: 200px;
        }
        .accordion-item.active .arrow-icon {
            transform: rotate(180deg);
        }

        /* 底欄導航 */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 70px;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(191, 149, 63, 0.3);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
        }
        .nav-item { font-size: 10px; color: #666; transition: 0.3s; }
        .nav-item.active { color: #BF953F; }
    </style>
</head>
<body class="px-5">

    <div id="page-member" class="page-content py-8">
        <header class="text-center mb-8">
            <h1 class="text-2xl gold-text mb-1">美業升等集點卡</h1>
            <p class="text-[9px] tracking-[0.4em] text-gray-600">PERSONAL LOYALTY CARD</p>
        </header>

        <main class="space-y-6">
            <section class="luxury-card p-6">
                <div class="flex items-center space-x-4 mb-6">
                    <div class="w-12 h-12 rounded-full border border-[#BF953F] flex items-center justify-center bg-black gold-text text-xl">✦</div>
                    <div>
                        <h2 id="client-name" class="text-lg font-bold text-white">載入中...</h2>
                        <p id="client-phone" class="text-xs text-gray-500 font-mono">---</p>
                    </div>
                </div>
                <div class="flex justify-between items-end mb-3">
                    <h3 id="tier-display" class="text-lg gold-text">等級 0 入門會員</h3>
                    <p id="total-spent" class="text-lg text-white font-light">$0</p>
                </div>
                <div class="w-full h-1 bg-gray-900 rounded-full mb-2 overflow-hidden">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-[#BF953F] to-[#FCF6BA] transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p id="incentive-text" class="text-[10px] text-gray-500 italic text-center"></p>
            </section>

            <section class="luxury-card p-6 border-dashed border-[#BF953F]/30">
                <p class="text-[10px] text-gray-600 text-center uppercase mb-4">店員快速核銷</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="simulateTransaction(2000)" class="btn-luxury-cycle py-3 text-xs col-span-2">結帳 $2,000</button>
                    <button onclick="handleCheckin()" class="btn-luxury-cycle py-3 text-xs">手動集點</button>
                    <button onclick="resetDemo()" class="btn-luxury-cycle py-3 text-xs text-red-900">重置</button>
                </div>
            </section>
        </main>
    </div>

    <div id="page-list" class="page-content py-8 hidden">
        <header class="text-center mb-8">
            <h1 class="text-2xl gold-text mb-1">名單總覽</h1>
            <p class="text-[9px] tracking-[0.4em] text-gray-600">MEMBER DIRECTORY</p>
        </header>

        <div id="member-directory" class="space-y-3">
            </div>
    </div>

    <nav class="bottom-nav">
        <button onclick="switchPage('member')" id="nav-member" class="nav-item active flex flex-col items-center">
            <span class="text-xl mb-1">◈</span>
            <span>我的卡片</span>
        </button>
        <button onclick="switchPage('list')" id="nav-list" class="nav-item flex flex-col items-center">
            <span class="text-xl mb-1">☷</span>
            <span>名單總覽</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, getDoc, setDoc, collection, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
            authDomain: "holyhairsalon-f73bf.firebaseapp.com",
            databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
            projectId: "holyhairsalon-f73bf",
            storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
            messagingSenderId: "960169055224",
            appId: "1:960169055224:web:64c044f4484f267abf3c0d",
            measurementId: "G-TLM1NMF4Y1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const currentUserId = "MEMBER_USER_001"; // 模擬目前登入者
        const userRef = doc(db, "customers", currentUserId);

        const RULES = [
            { level: 0, name: "入門會員", threshold: 1000 },
            { level: 1, name: "基礎會員", threshold: 3000 },
            { level: 2, name: "熟客會員", threshold: 5000 },
            { level: 3, name: "優選會員", threshold: 7000 },
            { level: 4, name: "菁英會員", threshold: 10000 },
            { level: 5, name: "尊榮會員", threshold: 99999 }
        ];

        // 頁面切換邏輯
        window.switchPage = (pageId) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            if(pageId === 'list') renderDirectory();
        };

        // 監聽目前使用者
        onSnapshot(userRef, (snap) => {
            if (snap.exists()) updateMemberCard(snap.data());
            else initUser();
        });

        function updateMemberCard(data) {
            document.getElementById('client-name').innerText = data.name;
            document.getElementById('client-phone').innerText = data.phone;
            document.getElementById('total-spent').innerText = `$${data.total_spent.toLocaleString()}`;
            
            let current = RULES.findLast(r => data.total_spent >= (RULES[r.level-1]?.threshold || 0)) || RULES[0];
            document.getElementById('tier-display').innerText = `等級 ${current.level} ${current.name}`;
            
            const next = RULES[current.level + 1];
            if (next) {
                const prog = (data.total_spent / next.threshold) * 100;
                document.getElementById('progress-bar').style.width = `${Math.min(prog, 100)}%`;
                document.getElementById('incentive-text').innerText = `距 ${next.name} 還差 $${(next.threshold - data.total_spent).toLocaleString()}`;
            }
        }

        // 渲染名單總覽 (風琴卡片)
        async function renderDirectory() {
            const container = document.getElementById('member-directory');
            // 這裡模擬從 Collection 獲取多筆資料，實務上會使用 query(collection(db, "customers"))
            const snap = await getDoc(userRef); 
            const data = snap.data();
            
            // 模擬三筆展示數據
            const members = [data, {name: "李大華", phone: "0922-111-222", total_spent: 5500, stamps: 8}, {name: "陳小美", phone: "0933-444-555", total_spent: 12000, stamps: 2}];
            
            container.innerHTML = members.map((m, index) => {
                const tier = RULES.findLast(r => m.total_spent >= (RULES[r.level-1]?.threshold || 0)) || RULES[0];
                return `
                <div class="accordion-item luxury-card" onclick="this.classList.toggle('active')">
                    <div class="p-5 flex justify-between items-center cursor-pointer">
                        <div>
                            <span class="text-xs gold-text font-bold">LV.${tier.level}</span>
                            <span class="ml-2 text-white font-medium">${m.name}</span>
                        </div>
                        <span class="arrow-icon text-gray-600 transition-transform">▼</span>
                    </div>
                    <div class="accordion-content bg-black/40 px-5 border-t border-white/5">
                        <div class="py-4 space-y-2 text-xs">
                            <div class="flex justify-between"><span class="text-gray-500">連絡電話</span><span class="text-gray-300 font-mono">${m.phone}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">會員身分</span><span class="text-yellow-600">${tier.name}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">累積消費</span><span class="text-white">$${m.total_spent.toLocaleString()}</span></div>
                            <div class="pt-2 flex gap-1">
                                ${Array(10).fill(0).map((_, i) => `<div class="stamp-slot ${i < m.stamps ? 'stamp-active' : ''}"></div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // 模擬功能...
        window.simulateTransaction = async (amount) => {
            const snap = await getDoc(userRef);
            const data = snap.data();
            await updateDoc(userRef, { total_spent: data.total_spent + amount, stamps: (data.stamps + 1) % 11 });
        };

        window.handleCheckin = async () => {
            const snap = await getDoc(userRef);
            await updateDoc(userRef, { stamps: (snap.data().stamps + 1) % 11 });
        };

        window.resetDemo = async () => {
            await setDoc(userRef, { name: "王小明", phone: "0912-345-678", total_spent: 0, stamps: 0 });
        };

        async function initUser() {
            await setDoc(userRef, { name: "王小明", phone: "0912-345-678", total_spent: 1500, stamps: 3 });
        }
    </script>
</body>
</html>
