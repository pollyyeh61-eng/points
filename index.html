<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾æ¥­ç®¡ç†ç³»çµ± | HOLY HAIR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-gradient: linear-gradient(135deg, #BF953F 0%, #FCF6BA 45%, #B38728 70%, #FBF5B7 85%, #AA771C 100%);
            --dark-bg: #050505;
        }

        body {
            background-color: var(--dark-bg);
            color: #D4D4D4;
            font-family: 'Noto Sans TC', sans-serif;
            background-image: radial-gradient(circle at 50% 10%, #1a1a1a 0%, #050505 100%);
            min-height: 100vh;
            padding-bottom: 90px;
        }

        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .luxury-card {
            background: rgba(15, 15, 15, 0.85);
            border: 1px solid rgba(191, 149, 63, 0.2);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            animation: card-breathe 5s ease-in-out infinite;
        }

        @keyframes card-breathe {
            0%, 100% { border-color: rgba(191, 149, 63, 0.2); box-shadow: 0 0 15px rgba(0,0,0,0.8); }
            50% { border-color: rgba(191, 149, 63, 0.5); box-shadow: 0 0 35px rgba(191, 149, 63, 0.15); }
        }

        .btn-luxury-cycle {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #8A6E2F;
            border-radius: 12px;
            animation: btn-glow-cycle 4s infinite;
            transition: all 0.3s;
        }

        @keyframes btn-glow-cycle {
            0%, 100% { color: #8A6E2F; border-color: #8A6E2F; }
            50% { color: #FCF6BA; border-color: #FCF6BA; box-shadow: 0 0 15px rgba(252, 246, 186, 0.2); }
        }

        input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(191, 149, 63, 0.2);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            width: 100%;
        }

        .stamp-slot { width: 30px; height: 30px; border-radius: 50%; border: 1px solid rgba(191, 149, 63, 0.2); background: rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .stamp-active { background: var(--gold-gradient); color: #000; border: none; }

        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-item.active .accordion-content { max-height: 300px; padding-bottom: 20px; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: rgba(5,5,5,0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(191, 149, 63, 0.2); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { font-size: 11px; color: #555; transition: 0.3s; }
        .nav-item.active { color: #BF953F; }
    </style>
</head>
<body class="px-5">

    <div id="page-member" class="page-content py-6">
        <header class="text-center mb-6">
            <h1 class="text-2xl gold-text mb-1">ç¾æ¥­å‡ç­‰é›†é»å¡</h1>
            <p class="text-[9px] tracking-[0.4em] text-gray-600 uppercase">Personal VIP Controller</p>
        </header>

        <section class="luxury-card p-5 mb-6 border-[#BF953F]/10">
            <h3 class="text-[10px] gold-text mb-3 tracking-widest uppercase">æ–°æœƒå“¡å»ºæª”</h3>
            <div class="space-y-3">
                <input type="text" id="reg-name" placeholder="è«‹è¼¸å…¥å§“å">
                <input type="tel" id="reg-phone" placeholder="è«‹è¼¸å…¥é›»è©±">
                <button onclick="registerNewMember()" class="w-full btn-luxury-cycle py-2 text-xs font-bold">å»ºç«‹ä¸¦ç™¼è¡Œæ–°å¡é»</button>
            </div>
        </section>

        <main class="space-y-6">
            <section class="luxury-card p-6" id="main-card">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <span id="display-card-id" class="text-[10px] text-gray-500 font-mono tracking-widest">ID: ---</span>
                        <h2 id="display-name" class="text-2xl font-bold text-white tracking-wide mt-1">æœªç™»éŒ„</h2>
                        <p id="display-phone" class="text-xs text-gray-500 font-mono mt-1">è«‹å…ˆæ–¼ä¸Šæ–¹å»ºæª”æˆ–æŸ¥è©¢</p>
                    </div>
                    <div class="w-10 h-10 rounded-full border border-[#BF953F] flex items-center justify-center gold-text">âœ¦</div>
                </div>

                <div class="flex justify-between items-end mb-3">
                    <div>
                        <span class="text-[10px] text-gray-500 uppercase">ç•¶å‰ç­‰ç´š</span>
                        <h3 id="tier-display" class="text-lg gold-text">LV.0 å…¥é–€æœƒå“¡</h3>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] text-gray-500 uppercase">æ¶ˆè²»ç¸½é¡</span>
                        <p id="total-spent" class="text-xl text-white font-light">$0</p>
                    </div>
                </div>

                <div class="w-full h-1 bg-gray-900 rounded-full mb-2">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-[#BF953F] to-[#FCF6BA] transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p id="incentive-text" class="text-[10px] text-gray-500 italic text-center"></p>
            </section>

            <section class="grid grid-cols-2 gap-3">
                <button onclick="handleCheckOut(1500)" class="btn-luxury-cycle py-4 text-sm font-bold col-span-2">æœå‹™çµå¸³ ($1,500)</button>
                <button onclick="addStamp()" class="btn-luxury-cycle py-3 text-xs">å–®æ¬¡é›†é»</button>
                <button onclick="location.reload()" class="btn-luxury-cycle py-3 text-xs opacity-50">åˆ·æ–°åŒæ­¥</button>
            </section>
        </main>
    </div>

    <div id="page-list" class="page-content py-6 hidden">
        <header class="text-center mb-6">
            <h1 class="text-2xl gold-text mb-1">åå–®ç¸½è¦½</h1>
            <p class="text-[9px] tracking-[0.4em] text-gray-600 uppercase">Member Directory</p>
        </header>
        <div id="member-directory" class="space-y-3">
            </div>
    </div>

    <nav class="bottom-nav">
        <button onclick="switchPage('member')" id="nav-member" class="nav-item active flex flex-col items-center">
            <span class="text-xl mb-1">â—ˆ</span><span>æ§åˆ¶é¢æ¿</span>
        </button>
        <button onclick="switchPage('list')" id="nav-list" class="nav-item flex flex-col items-center">
            <span class="text-xl mb-1">â˜·</span><span>åå–®ç¸½è¦½</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
            authDomain: "holyhairsalon-f73bf.firebaseapp.com",
            databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
            projectId: "holyhairsalon-f73bf",
            storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
            messagingSenderId: "960169055224",
            appId: "1:960169055224:web:64c044f4484f267abf3c0d",
            measurementId: "G-TLM1NMF4Y1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let activeUserId = "001"; // é è¨­æ“ä½œç¬¬ä¸€å€‹æœƒå“¡

        const RULES = [
            { level: 0, name: "å…¥é–€æœƒå“¡", threshold: 1000 },
            { level: 1, name: "åŸºç¤æœƒå“¡", threshold: 3000 },
            { level: 2, name: "ç†Ÿå®¢æœƒå“¡", threshold: 5000 },
            { level: 3, name: "å„ªé¸æœƒå“¡", threshold: 7000 },
            { level: 4, name: "èè‹±æœƒå“¡", threshold: 10000 },
            { level: 5, name: "å°Šæ¦®æœƒå“¡", threshold: 999999 }
        ];

        // 1. æœƒå“¡è¨»å†Šèˆ‡è‡ªå‹•æ’åºå¡è™Ÿ
        window.registerNewMember = async () => {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            if(!name || !phone) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

            const colRef = collection(db, "customers");
            const snapshot = await getDocs(colRef);
            const nextId = String(snapshot.size + 1).padStart(3, '0');

            await setDoc(doc(db, "customers", nextId), {
                id: nextId,
                name: name,
                phone: phone,
                total_spent: 0,
                stamps: 0,
                created_at: Date.now()
            });

            activeUserId = nextId;
            alert(`è¨»å†ŠæˆåŠŸï¼æœƒå“¡ç·¨è™Ÿï¼š${nextId}`);
            bindActiveMember();
        };

        // 2. ç¶å®šç›®å‰æ­£åœ¨æ“ä½œçš„æœƒå“¡ç›£è½
        function bindActiveMember() {
            onSnapshot(doc(db, "customers", activeUserId), (snap) => {
                if(snap.exists()) updateUI(snap.data());
            });
        }

        function updateUI(data) {
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('display-phone').innerText = data.phone;
            document.getElementById('display-card-id').innerText = `ID: ${data.id}`;
            document.getElementById('total-spent').innerText = `$${data.total_spent.toLocaleString()}`;
            
            let current = RULES.findLast(r => data.total_spent >= (RULES[r.level-1]?.threshold || 0)) || RULES[0];
            document.getElementById('tier-display').innerText = `LV.${current.level} ${current.name}`;
            
            const next = RULES[current.level + 1];
            if(next) {
                const prog = (data.total_spent / next.threshold) * 100;
                document.getElementById('progress-bar').style.width = `${Math.min(prog, 100)}%`;
                document.getElementById('incentive-text').innerText = `è· ${next.name} é‚„å·® $${(next.threshold - data.total_spent).toLocaleString()}`;
            }
        }

        // 3. çµå¸³åŠŸèƒ½ä¿®å¾© (ä½¿ç”¨ async/await ç¢ºä¿ Firebase é€šè¨ŠæˆåŠŸ)
        window.handleCheckOut = async (amount) => {
            try {
                const userRef = doc(db, "customers", activeUserId);
                const snap = await getDoc(userRef);
                if(!snap.exists()) return alert("è«‹å…ˆå»ºç«‹æœƒå“¡è³‡æ–™");

                const currentData = snap.data();
                const newTotal = currentData.total_spent + amount;
                const newStamps = (currentData.stamps + 1) % 11;

                await updateDoc(userRef, {
                    total_spent: newTotal,
                    stamps: newStamps
                });
                
                // æª¢æŸ¥æ˜¯å¦è·¨ç´š
                const nextRule = RULES[currentData.level + 1];
                if(newTotal >= nextRule?.threshold) alert(`ğŸ‰ æ­å–œå‡ç­‰ç‚º ${nextRule.name}ï¼`);
                
            } catch (error) {
                console.error("çµå¸³å¤±æ•—:", error);
                alert("çµå¸³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥");
            }
        };

        window.addStamp = async () => {
            const userRef = doc(db, "customers", activeUserId);
            const snap = await getDoc(userRef);
            await updateDoc(userRef, { stamps: (snap.data().stamps + 1) % 11 });
        };

        // 4. åˆ†é åˆ‡æ›èˆ‡åå–®æ¸²æŸ“
        window.switchPage = (pid) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${pid}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pid}`).classList.add('active');
            if(pid === 'list') renderDirectory();
        };

        async function renderDirectory() {
            const colRef = collection(db, "customers");
            const snapshot = await getDocs(colRef);
            const container = document.getElementById('member-directory');
            container.innerHTML = "";

            snapshot.forEach((docSnap) => {
                const m = docSnap.data();
                const tier = RULES.findLast(r => m.total_spent >= (RULES[r.level-1]?.threshold || 0)) || RULES[0];
                const item = document.createElement('div');
                item.className = "accordion-item luxury-card mb-3";
                item.innerHTML = `
                    <div class="p-4 flex justify-between items-center" onclick="this.parentElement.classList.toggle('active')">
                        <span class="text-xs gold-text font-bold">ID:${m.id}</span>
                        <span class="text-white">${m.name}</span>
                        <span class="text-[10px] text-gray-500">${tier.name}</span>
                    </div>
                    <div class="accordion-content bg-black/40 px-4">
                        <div class="py-3 space-y-2 text-xs border-t border-white/5">
                            <div class="flex justify-between"><span>é›»è©±</span><span>${m.phone}</span></div>
                            <div class="flex justify-between"><span>ç´¯ç©æ¶ˆè²»</span><span>$${m.total_spent}</span></div>
                            <div class="flex gap-1 mt-2">
                                ${Array(10).fill(0).map((_, i) => `<div class="stamp-slot ${i < m.stamps ? 'stamp-active' : ''}"></div>`).join('')}
                            </div>
                            <button onclick="activeUserId='${m.id}'; switchPage('member');" class="w-full mt-3 py-2 border border-[#BF953F]/30 text-[10px] gold-text">åˆ‡æ›è‡³æ­¤æœƒå“¡é€²è¡Œæ“ä½œ</button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // åˆå§‹åŒ–
        bindActiveMember();
    </script>
</body>
</html>
